{"version":3,"file":"withConfigTransport.js","sources":["../../src/services/component-config/component-config.ts","../../src/services/config-transport/createProxyComponent.ts","../../src/services/config-transport/withConfigTransport.ts"],"sourcesContent":["import { useLocalConfig } from '../../components/va-config/VaConfig'\nimport { useGlobalConfig } from '../global-config/global-config'\nimport { computed } from 'vue'\nimport type { VuesticComponentsMap } from '../../vuestic-plugin/global-components'\nimport type { DefineComponent, VNodeProps, AllowedComponentProps } from 'vue'\n\ntype VuesticComponentName = keyof VuesticComponentsMap\ntype VueDefaultPropNames = keyof (VNodeProps & AllowedComponentProps) | `on${string}`\n\nexport type PropTypes<C> = C extends { new(): { $props: infer Props } } ? Omit<Props, VueDefaultPropNames> : never\nexport type ComponentConfig = {\n  // key-value hack to avoid generics in type (like Omit, PropTypes, etc.)\n  // `key: type` as result\n  [componentName in VuesticComponentName]?: {\n    [key in keyof PropTypes<VuesticComponentsMap[componentName]>]: PropTypes<VuesticComponentsMap[componentName]>[key]\n  }\n}\n\nexport const useComponentConfigProps = <T extends DefineComponent>(component: T) => {\n  const localConfig = useLocalConfig()\n  const { globalConfig } = useGlobalConfig()\n\n  return computed(() => {\n    const globalConfigProps = {\n      ...globalConfig.value.componentsAll,\n      ...globalConfig.value.components?.[component.name as VuesticComponentName],\n    }\n\n    const localConfigProps = localConfig.value\n      .reduce((finalConfig, config) => config[component.name as VuesticComponentName]\n        ? { ...finalConfig, ...config[component.name as VuesticComponentName] }\n        : finalConfig\n      , {})\n\n    const props = { ...globalConfigProps, ...localConfigProps }\n\n    return props\n  })\n}\n\nexport type Props = Record<string, any>\n","import { getCurrentInstance, ComponentInternalInstance, DefineComponent, SetupContext, Ref, shallowReadonly } from 'vue'\nimport { useComponentConfigProps } from '../component-config/component-config'\n\n/** Compiled and reactive props. By default they passed to setup fn */\ntype Props = Record<string, unknown>;\n/** Raw props */\ntype RawProps = Record<string, unknown>;\n\n/**\n * @param propsFromConfig Ref of custom props. Required to be ref so vue can rerender component on custom props change.\n * @returns new props object, where some props replaced with props from config.\n */\nconst createPropsWithCustomConfig = (instance: ComponentInternalInstance, propsFromConfig: Ref<Props>) => {\n  /**\n   * Reactive and compiled props. Compiled props considering default value, Boolean transformation etc.\n   * It is a default props that passed to setup function.\n   */\n  const instanceProps: Props = instance.props\n\n  return new Proxy(instanceProps, {\n    get: (target, key: string) => {\n      /**\n       * Props passed to VNode. Not compiled at all and not reactive.\n       * VNode props contained only props passed from parent.\n       */\n      const incommingProps: RawProps = instance.vnode.props || {}\n\n      /**\n       * Make sure to access both original and from config prop in get.\n       * Since instanceProps and propsFromConfig both are reactive, we need to know that both of\n       * this objects are dependency of effect where proxy is used.\n       * If original prop will not be accessed vue will not track reactivity for original props object.\n       */\n      const originalProp = target[key]\n      const propFromConfig = propsFromConfig.value[key]\n\n      // Return prop from config only if user didn't pass props manually\n      if (incommingProps[key] === undefined && propFromConfig !== undefined) {\n        return propFromConfig\n      }\n\n      return originalProp\n    },\n  })\n}\n\n/**\n * Patch instance props with Proxy.\n * This will change props object during render and in Devtools.\n */\nconst patchInstanceProps = (instance: ComponentInternalInstance, props: Props) => {\n  instance.props = props\n}\n\nexport const createProxyComponent = <T extends DefineComponent>(component: T) => {\n  const customSetup = (originalProps: Props, ctx: SetupContext) => {\n    const instance = getCurrentInstance()! // Not null during setup call\n    const propsFromConfig = useComponentConfigProps(component)\n\n    const props = createPropsWithCustomConfig(instance, propsFromConfig)\n\n    patchInstanceProps(instance, props)\n\n    return component.setup?.(shallowReadonly(props), ctx)\n  }\n\n  return new Proxy(component, {\n    get (target, key: any) {\n      if (key === 'setup') { return customSetup }\n\n      return target[key]\n    },\n  })\n}\n","import { ComponentPublicInstance, DefineComponent } from 'vue'\nimport { createProxyComponent } from './createProxyComponent'\n\ntype WithConfigTransport<T> = T\n\nconst CLASS_COMPONENT_KEY = '__c'\n\nconst patchClassComponent = (component: { [CLASS_COMPONENT_KEY]: any }): any => {\n  component[CLASS_COMPONENT_KEY] = createProxyComponent(component[CLASS_COMPONENT_KEY])\n  return component\n}\n\n/** Allows props to be passed from vuestic config if they were not provided */\nexport const withConfigTransport = <T>(component: T): WithConfigTransport<T> => {\n  if ('setup' in component) {\n    return createProxyComponent(component as any)\n  } else if (CLASS_COMPONENT_KEY in component) {\n    // TODO: Remove this. We don't want to use class components\n    return patchClassComponent(component as any)\n  } else {\n    // Options api. We need to transform it to Composition API and then create proxy.\n    (component as any).setup = () => ({ /* Fake setup function */})\n    return createProxyComponent(component as any)\n  }\n}\n\nexport default withConfigTransport\n"],"names":[],"mappings":"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"}